<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make Ready Board</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #334155;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: 14px;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background-color: var(--bg-card);
            border-right: 1px solid var(--border);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 10;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .filter-section h3 {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-secondary);
            font-weight: 600;
            letter-spacing: 0.05em;
            margin-top: 8px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .filter-group label {
            display: block;
            font-size: 13px;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        select {
            width: 100%;
            padding: 10px;
            background-color: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            outline: none;
            font-size: 13px;
        }

        select:focus {
            border-color: var(--accent);
        }

        .btn-reset {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }

        .btn-reset:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .main-content {
            flex: 1;
            padding: 32px;
            margin-left: 280px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 32px;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .last-updated {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background-color: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid var(--border);
        }

        .stat-card .icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-card.blue .icon {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent);
        }

        .stat-card.warning .icon {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .stat-card.danger .icon {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .stat-card.success .icon {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .stat-card .info h3 {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .content-panel {
            background-color: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 24px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .actions {
            display: flex;
            gap: 12px;
        }

        #search-input {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-primary);
            width: 250px;
        }

        .btn-refresh {
            padding: 8px 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-refresh:hover {
            background: var(--accent-hover);
        }

        .btn-refresh:active {
            transform: translateY(1px);
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead {
            background: rgba(15, 23, 42, 0.5);
        }

        th {
            text-align: left;
            padding: 12px 16px;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .badge-none {
            background: rgba(148, 163, 184, 0.1);
            color: var(--text-secondary);
        }

        .badge-new {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent);
        }

        .badge-progress {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .badge-done {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 6px;
            position: relative;
            top: -1px;
        }

        .status-dot.green {
            background: var(--success);
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
        }

        .status-dot.red {
            background: var(--danger);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
        }

        /* Loading Overlay with Failsafe */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.9);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            pointer-events: none;
            /* CRITICAL: Allows clicks to pass through when this overlay is hidden/invisible */
        }

        #loading-overlay.active {
            display: flex;
            pointer-events: all;
            /* Blocks clicks only when active */
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Multi Select Styles */
        .multi-select {
            position: relative;
            user-select: none;
        }

        .select-box {
            background-color: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .select-box:hover {
            border-color: var(--text-secondary);
        }

        .checkboxes {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            margin-top: 4px;
        }

        .checkboxes.active {
            display: block;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.1s;
        }

        .checkbox-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .checkbox-item input {
            margin-right: 10px;
            accent-color: var(--accent);
        }

        .stat-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pagination-controls select {
            width: auto;
            padding: 6px 12px;
        }

        .page-info {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* RRWW EASTER EGG */
        #hidden-logo {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            font-weight: 900;
            color: #f1f5f9;
            text-shadow: 0 0 15px #3b82f6, 0 0 30px #3b82f6;
            z-index: 9999;
            pointer-events: none;
            text-transform: uppercase;
            letter-spacing: 5px;
        }

        .particle {
            position: fixed;
            background: #fff;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            animation: explode 1.2s ease-out forwards;
        }

        @keyframes explode {
            0% {
                transform: translate(0, 0) scale(1.5);
                opacity: 1;
            }

            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text" style="font-size:16px; color:white;">Checking Email for Reports...</div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo"><i class="fa-solid fa-clipboard-check"></i><span>MakeReady</span></div>
            <div class="filter-section">
                <h3>Core Filters</h3>
                <div class="filter-group">
                    <label>Territory</label>
                    <div class="multi-select" id="ms-territory">
                        <div class="select-box" onclick="toggleCheckboxes('ms-territory')">
                            <span class="selected-text">All Territories</span>
                            <i class="fa-solid fa-chevron-down" style="font-size:10px;"></i>
                        </div>
                        <div class="checkboxes" id="opts-territory">
                            <!-- Populated via JS -->
                        </div>
                    </div>
                </div>
                <div class="filter-group"><label>Property</label><select id="filter-property"
                        aria-label="Filter Property">
                        <option value="all">All Properties</option>
                    </select></div>
                <div class="filter-group"><label>Rent Ready?</label><select id="filter-ready"
                        aria-label="Filter Rent Ready">
                        <option value="all">All Statuses</option>
                        <option value="Yes">Yes (Ready)</option>
                        <option value="No">No (Not Ready)</option>
                    </select></div>
                <div class="filter-group">
                    <label>Inspection Status</label>
                    <div class="multi-select" id="ms-inspection">
                        <div class="select-box" onclick="toggleCheckboxes('ms-inspection')">
                            <span class="selected-text">All Statuses</span>
                            <i class="fa-solid fa-chevron-down" style="font-size:10px;"></i>
                        </div>
                        <div class="checkboxes" id="opts-inspection">
                            <label class="checkbox-item"><input type="checkbox" value="NONE" checked> No
                                Inspection</label>
                            <label class="checkbox-item"><input type="checkbox" value="NEW" checked> New</label>
                            <label class="checkbox-item"><input type="checkbox" value="IN PROGRESS" checked> In
                                Progress</label>
                            <label class="checkbox-item"><input type="checkbox" value="DONE" checked> Done</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="filter-section">
                <h3>Marketing Filters</h3>
                <div class="filter-group"><label>Posted to Website?</label><select id="filter-web"
                        aria-label="Filter Website">
                        <option value="all">All</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select></div>
                <div class="filter-group"><label>Posted to Internet?</label><select id="filter-net"
                        aria-label="Filter Internet">
                        <option value="all">All</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select></div>
                <div class="filter-group"
                    style="margin-top:24px; border-top:1px solid var(--border); padding-top:16px;">
                    <label>Hidden Units</label>
                    <select id="filter-hidden-mode" aria-label="Hidden Units Mode">
                        <option value="hide" selected>Hide (Default)</option>
                        <option value="all">Show All</option>
                        <option value="only">Show Only Hidden</option>
                    </select>
                    <div style="text-align:right; margin-top:4px;">
                        <button onclick="unhideAll()"
                            style="background:none; border:none; color:var(--text-secondary); font-size:11px; cursor:pointer; text-decoration:underline;">Unhide
                            All</button>
                    </div>
                </div>
            </div>
            <button class="btn-reset" onclick="resetFilters()">Reset All Filters</button>
        </aside>

        <!-- Main -->
        <main class="main-content">
            <header>
                <h1>Make Ready Overview</h1>
                <div class="last-updated">Last Updated: <span id="last-updated-date">Waiting for data...</span></div>
            </header>
            <div id="debug-container" style="display:none; margin-bottom: 20px;">
                <div style="background: #2a0000; border: 1px solid #ff4444; border-radius: 8px; padding: 15px;">
                    <h4 style="color: #ff4444; margin-top: 0; margin-bottom: 10px;">Debug Log (Server)</h4>
                    <pre id="debug-log"
                        style="color: #ffcccc; font-family: 'Courier New', monospace; font-size: 11px; white-space: pre-wrap; margin: 0; max-height: 200px; overflow-y: auto;"></pre>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card blue" onclick="applyQuickFilter('vacant')">
                    <div class="icon"><i class="fa-solid fa-house-chimney-crack"></i></div>
                    <div class="info">
                        <h3>Total Vacant</h3>
                        <div class="value" id="val-vacant">--</div>
                    </div>
                </div>
                <div class="stat-card warning" onclick="applyQuickFilter('not-ready')">
                    <div class="icon"><i class="fa-solid fa-tools"></i></div>
                    <div class="info">
                        <h3>Not Rent Ready</h3>
                        <div class="value" id="val-not-ready">--</div>
                    </div>
                </div>
                <div class="stat-card danger" onclick="applyQuickFilter('no-insp')">
                    <div class="icon"><i class="fa-solid fa-clipboard-question"></i></div>
                    <div class="info">
                        <h3>No Inspection</h3>
                        <div class="value" id="val-no-insp">--</div>
                    </div>
                </div>
                <!-- Remove clickable from Avg because it's not a filter set -->
                <div class="stat-card success">
                    <div class="icon"><i class="fa-solid fa-hourglass-half"></i></div>
                    <div class="info">
                        <h3>Avg Days Vacant</h3>
                        <div class="value" id="val-avg-days">--</div>
                    </div>
                </div>
            </div>

            <div class="content-panel">
                <div class="panel-header">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <h2>Unit Status</h2>
                        <div class="pagination-controls">
                            <span class="page-info" id="page-info">Showing 1-25 of 100</span>
                            <div style="display:flex;gap:4px">
                                <button id="prev-page" class="btn-reset" style="width:auto;padding:6px 12px;"
                                    onclick="changePage(-1)" disabled><i class="fa-solid fa-chevron-left"></i></button>
                                <button id="next-page" class="btn-reset" style="width:auto;padding:6px 12px;"
                                    onclick="changePage(1)" disabled><i class="fa-solid fa-chevron-right"></i></button>
                            </div>
                            <select id="page-size" onchange="renderDashboard()" style="width:auto; margin-left:8px;">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="1000">All</option>
                            </select>
                        </div>
                    </div>
                    <div class="actions">
                        <input type="text" id="search-input" placeholder="Search Property or Unit...">
                        <button class="btn-refresh" onclick="loadData()"><i class="fa-solid fa-rotate"
                                id="refresh-icon"></i> Refresh Data</button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Property</th>
                                <th>Unit</th>
                                <th>Bed/Bath</th>
                                <th>Move Out</th>
                                <th>Days Vacant</th>
                                <th>Inspection</th>
                                <th>Work Order</th>
                                <th>Est. Status</th>
                                <th>Rent Ready?</th>
                                <th>Marketing</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="hidden-logo">RRWW</div>

    <script>
        let appData = { masterList: [], hidden: new Set() };
        let activePage = 1;

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.multi-select')) {
                document.querySelectorAll('.checkboxes').forEach(el => el.classList.remove('active'));
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            console.log("App Initialized - NO OVERLAY VERSION");
            setupFilters();
            loadData();
        });

        // ... (setupFilters, etc. stay same) ...

        function setupFilters() {
            // Setup simple selects
            const ids = ['filter-property', 'filter-ready', 'filter-web', 'filter-net', 'search-input', 'filter-hidden-mode'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', (e) => {
                    activePage = 1; // Reset page on filter change
                    renderDashboard();
                });
            });

            // Setup Multi Select Listeners (Checkbox changes)
            document.querySelectorAll('.multi-select input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', () => {
                    activePage = 1;
                    updateMultiSelectLabel(cb.closest('.multi-select').id);
                    // If Territory changed, update properties (advanced logic omitted for simplicity or can be added: specific territories -> filtered properties)
                    if (cb.closest('#ms-territory')) populatePropertyFilter();
                    renderDashboard();
                });
            });

            // Init labels
            updateMultiSelectLabel('ms-territory');
            updateMultiSelectLabel('ms-inspection');
        }

        function toggleCheckboxes(id) {
            const el = document.getElementById(id);
            const list = el.querySelector('.checkboxes');
            // Close others
            document.querySelectorAll('.checkboxes').forEach(c => {
                if (c !== list) c.classList.remove('active');
            });
            list.classList.toggle('active');
        }

        function updateMultiSelectLabel(id) {
            const el = document.getElementById(id);
            const checkboxes = el.querySelectorAll('input[type="checkbox"]');
            const checked = Array.from(checkboxes).filter(c => c.checked);
            const label = el.querySelector('.selected-text');

            if (checked.length === 0 || checked.length === checkboxes.length) {
                // Determine 'All' label based on id
                let name = id.includes('territory') ? 'All Territories' : 'All Statuses';
                label.innerText = name;
            } else {
                label.innerText = `${checked.length} Selected`;
            }
        }

        function getMultiSelectValues(id) {
            const el = document.getElementById(id);
            const checkboxes = el.querySelectorAll('input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(c => c.checked);
            // If ALL are checked or NONE are checked, treat as ALL (logic preference: usually 'none checked' means 'show none' but for filters often means 'reset'. I'll treat none as all to prevent empty screen, or maybe show empty. Let's treat NONE as ALL for ease of use.)
            if (allChecked || Array.from(checkboxes).every(c => !c.checked)) return 'all';

            return Array.from(checkboxes).filter(c => c.checked).map(c => c.value);
        }

        function setMultiSelectValues(id, values) { // helpers for reset/quick filter
            const el = document.getElementById(id);
            const checkboxes = el.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(c => {
                c.checked = values === 'all' || values.includes(c.value);
            });
            updateMultiSelectLabel(id);
        }

        function resetFilters() {
            setMultiSelectValues('ms-territory', 'all');
            setMultiSelectValues('ms-inspection', 'all');

            document.getElementById('filter-property').value = 'all';
            document.getElementById('filter-hidden-mode').value = 'hide';
            document.getElementById('filter-ready').value = 'all';
            document.getElementById('filter-web').value = 'all';
            document.getElementById('filter-net').value = 'all';
            document.getElementById('search-input').value = '';

            activePage = 1;
            populatePropertyFilter();
            renderDashboard();
        }

        function changePage(delta) {
            activePage += delta;
            renderDashboard();
        }

        function applyQuickFilter(type) {
            resetFilters(); // Start clean
            if (type === 'vacant') {
                // Just show all (reset does this)
            } else if (type === 'not-ready') {
                document.getElementById('filter-ready').value = 'No';
            } else if (type === 'no-insp') {
                // Valid list is 'NONE'
                setMultiSelectValues('ms-inspection', ['NONE']);
            }
            renderDashboard();
        }

        // ... (loadData/onDataSuccess stay same) ...
        function loadData() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.add('active');
                overlay.style.display = 'flex';
            }

            const icon = document.getElementById('refresh-icon');
            if (icon) icon.classList.add('fa-spin');

            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                console.log("Local Mode - Loading Mock Data");
                setTimeout(() => {
                    onDataSuccess({
                        status: 'success',
                        data: {
                            vacancies: [{ "Property": "11FIF6000 - Test Prop", "Unit": "101", "Days Vacant": 5, "Rent Ready": "No", "Territory": "North" }],
                            moveOuts: [], inspections: [], workOrders: [], timestamp: "Local Test"
                        }
                    });
                }, 500);
            } else {
                google.script.run.withSuccessHandler(onDataSuccess).withFailureHandler(onDataFail).getData();
            }
        }

        function onDataFail(err) {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.remove('active');
                overlay.style.display = 'none';
            }

            const icon = document.getElementById('refresh-icon');
            if (icon) icon.classList.remove('fa-spin');
            alert("Error: " + err);
        }

        function onDataSuccess(response) {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.remove('active');
                overlay.style.display = 'none';
            }

            const icon = document.getElementById('refresh-icon');
            if (icon) icon.classList.remove('fa-spin');

            if (!response || response.status !== 'success') {
                alert("Server Error: " + (response ? response.message : "Unknown"));
                return;
            }

            const data = response.data;
            // Check if we actually got data

            // ALWAYS Show Debug on Screen (User Request to Verify Logic)
            if (data.debug) {
                const debugEl = document.getElementById('debug-log');
                const debugCont = document.getElementById('debug-container');
                if (debugEl && debugCont) {
                    debugEl.textContent = Array.isArray(data.debug) ? data.debug.join('\n') : data.debug;
                    // debugCont.style.display = 'block'; // HIDDEN BY DEFAULT NOW
                }
                console.log("Server Debug:", data.debug);
            }

            // LOAD HIDDEN STATE
            if (data.hiddenList) {
                appData.hidden = new Set(data.hiddenList);
                logToScreen(`Loaded ${appData.hidden.size} hidden units.`);
            } else if (typeof google === 'undefined') {
                // Local Dev Fallback
                const localHidden = JSON.parse(localStorage.getItem('mrb_hidden') || '[]');
                appData.hidden = new Set(localHidden);
            }

            // Check if we actually got data
            const totalItems = (data.moveOuts?.length || 0) + (data.vacancies?.length || 0);
            if (totalItems === 0) {
                console.warn("No data returned from server.");
                let msg = "No relevant data found in the last 5 days of emails. See Debug Log on screen.";
                alert(msg);
            }

            processData(response.data);
            renderDashboard();
        }

        function normalizeUnit(unit) { return unit ? unit.toString().trim() : "Unknown"; }

        // EXPLICIT KEY GENERATION: Trust 'Property Name' completely.
        function getKey(propName, unit) {
            if (!propName) return null; // Garbage data
            // Ensure both are trimmed strings
            return `${propName.trim()}-${normalizeUnit(unit)}`;
        }

        // Simple Territory extraction from the first 2 chars of the clean ID
        function deriveTerritory(propName) {
            if (!propName || propName.length < 2) return 'Other';
            const prefix = propName.trim().substring(0, 2);
            switch (prefix) {
                case '11': return 'Commercial';
                case '12': return 'COS';
                case '13': return 'Aurora';
                case '14': return 'Denver Central';
                case '16': return 'OKC';
                case '17': return 'Fitz';
                case '18': return 'GLVV';
                default: return 'Other';
            }
        }

        // CLIENT SIDE LOGGER
        function logToScreen(msg) {
            const debugEl = document.getElementById('debug-log');
            if (debugEl) {
                const time = new Date().toLocaleTimeString();
                debugEl.textContent += `\n[CLIENT ${time}] ${msg}`;
            }
            console.log(msg);
        }

        function processData(rawData) {
            logToScreen("Starting ProcessData...");
            if (!rawData) { logToScreen("Error: rawData is null"); return; }

            const merged = new Map();
            const safeInt = (v) => parseInt(v) || 0;

            // HELPER: Fuzzy match column names
            const getCol = (row, colName) => {
                if (!row) return "";
                const cleanName = colName.toLowerCase().trim();
                if (row[colName] !== undefined) return row[colName];
                const keys = Object.keys(row);
                for (let k of keys) {
                    if (k.toLowerCase().trim() === cleanName) return row[k];
                }
                return "";
            };

            // 1. BASE: VACANCIES
            if (rawData.vacancies && rawData.vacancies.length > 0) {
                logToScreen(`Found ${rawData.vacancies.length} Vacancy Rows.`);

                // DEBUG FIRST ROW
                const first = rawData.vacancies[0];
                logToScreen(`Row 0 Keys: ${JSON.stringify(Object.keys(first))}`);
                logToScreen(`Row 0 'Property Name' check: '${getCol(first, 'Property Name')}'`);


                let successCount = 0;
                rawData.vacancies.forEach((row, idx) => {
                    try {
                        const prop = getCol(row, 'Property Name') || getCol(row, 'Property') || getCol(row, 'Property ID');
                        if (!prop || prop === 'Total') {
                            // Silent skip for clarity, debug only if needed
                            // if (idx < 5) logToScreen(`Skipping Row ${idx}: No Property Name found. (Val: '${prop}')`);
                            return;
                        }

                        const unit = getCol(row, 'Unit');
                        const key = getKey(prop, unit);

                        merged.set(key, {
                            key: key,
                            property: prop,
                            territory: deriveTerritory(prop),
                            unit: normalizeUnit(unit),
                            daysVacant: safeInt(getCol(row, 'Days Vacant')),
                            rentReady: (getCol(row, 'Rent Ready') || '').toLowerCase() === 'yes',
                            postedWeb: (getCol(row, 'Posted To Website') || '').toLowerCase() === 'yes',
                            postedNet: (getCol(row, 'Posted To Internet') || '').toLowerCase() === 'yes',
                            // Placeholders
                            moveOutDate: null,
                            inspectionStatus: 'NONE',
                            workOrderStatus: 'NONE',
                            unit: normalizeUnit(unit),
                            bedBath: (getCol(row, 'Bed/Bath') || '').split('/').map(s => { const n = parseFloat(s); return isNaN(n) ? s : n; }).join('/') || '-',
                            daysVacant: safeInt(getCol(row, 'Days Vacant')),
                            rentReady: (getCol(row, 'Rent Ready') || '').toLowerCase() === 'yes',
                            postedWeb: (getCol(row, 'Posted To Website') || '').toLowerCase() === 'yes',
                            postedNet: (getCol(row, 'Posted To Internet') || '').toLowerCase() === 'yes',
                            // Placeholders
                            moveOutDate: null,
                            inspectionStatus: 'NONE',
                            workOrderStatus: 'NONE',
                            workOrderEst: '',
                            estApprovalStatus: '-'
                        });
                        successCount++;
                    } catch (err) {
                        logToScreen(`Error processing row ${idx}: ${err.message}`);
                    }
                });
                logToScreen(`Successfully merged ${successCount} Vacancy items.`);
            }

            // 2. ENRICH: MOVE OUTS
            if (rawData.moveOuts) {
                rawData.moveOuts.forEach(row => {
                    const prop = getCol(row, 'Property Name');
                    if (!prop) return;

                    const unit = getCol(row, 'Unit');
                    const key = getKey(prop, unit);
                    const mDate = getCol(row, 'Move Out Date') || getCol(row, 'Move-out Date');

                    if (merged.has(key)) {
                        merged.get(key).moveOutDate = mDate;
                    } else {
                        // Orphaned Move Out
                        merged.set(key, {
                            key: key,
                            property: prop,
                            territory: deriveTerritory(prop),
                            unit: normalizeUnit(unit),
                            daysVacant: 0,
                            rentReady: false,
                            postedWeb: false,
                            postedNet: false,
                            moveOutDate: mDate,
                            inspectionStatus: 'NONE',
                            workOrderStatus: 'NONE'
                        });
                    }
                });
            }

            // 3. ENRICH: INSPECTIONS
            if (rawData.inspections) {
                rawData.inspections.forEach(row => {
                    const prop = getCol(row, 'Property Name');
                    if (!prop) return;

                    const key = getKey(prop, getCol(row, 'Unit'));
                    // Default to NEW if status is missing but row exists
                    const status = (getCol(row, 'Status') || 'NEW').toUpperCase();

                    if (merged.has(key)) {
                        const item = merged.get(key);
                        if (item.inspectionStatus === 'NONE' || status !== 'DONE') {
                            item.inspectionStatus = status;
                        }
                    }
                });
            }

            // 4. ENRICH: WORK ORDERS
            if (rawData.workOrders) {
                rawData.workOrders.forEach(row => {
                    const prop = getCol(row, 'Property Name');
                    if (!prop) return;

                    const key = getKey(prop, getCol(row, 'Unit'));
                    const status = getCol(row, 'Status');

                    if (merged.has(key) && status && status !== 'Closed' && status !== 'Cancelled') {
                        merged.get(key).workOrderStatus = status;
                        merged.get(key).workOrderStatus = status;
                        merged.get(key).workOrderEst = getCol(row, 'Estimate Amount');
                        merged.get(key).estApprovalStatus = getCol(row, 'Estimate Approval Status') || '-';
                    }
                });
            }

            appData.masterList = Array.from(merged.values());
            console.log("Merged Data Points:", appData.masterList.length);
            appData.masterList.sort((a, b) => b.daysVacant - a.daysVacant);

            const dateSpan = document.getElementById('last-updated-date');
            if (dateSpan) dateSpan.innerText = rawData.timestamp || new Date().toLocaleString();

            populateTerritoryFilter();
            populatePropertyFilter();
        }

        function populateTerritoryFilter() {
            const container = document.getElementById('opts-territory');
            if (!container) return;
            // distinct territories
            const territories = [...new Set(appData.masterList.map(i => i.territory))].sort();

            // Check existing checked values to preserve state if possible
            // For simple re-render, we might nuke and rebuild.
            container.innerHTML = '';

            // Add "All" pseudo-option or just list them. Multi-select implies list.
            territories.forEach(t => {
                const label = document.createElement('label');
                label.className = 'checkbox-item';
                label.innerHTML = `<input type="checkbox" value="${t}" checked> ${t}`;
                // Add event listener directly or rely on bubbling setup in setupFilters? 
                // Bubbling is safer if we rebuild DOM.
                label.querySelector('input').addEventListener('change', () => {
                    activePage = 1;
                    updateMultiSelectLabel('ms-territory');
                    populatePropertyFilter();
                    renderDashboard();
                });
                container.appendChild(label);
            });
            updateMultiSelectLabel('ms-territory');
        }

        function populatePropertyFilter() {
            const select = document.getElementById('filter-property');
            const terrSelect = document.getElementById('filter-territory'); // Legacy ref check
            if (!select) return;
            const curr = select.value;

            const terrVals = getMultiSelectValues('ms-territory');
            let list = appData.masterList;
            if (terrVals !== 'all') {
                list = list.filter(i => terrVals.includes(i.territory));
            }

            const props = [...new Set(list.map(i => i.property))].sort();

            select.innerHTML = '<option value="all">All Properties</option>';
            props.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.innerText = p;
                select.appendChild(opt);
            });

            if (props.includes(curr)) select.value = curr;
        }

        function renderDashboard() {
            if (!appData.masterList) appData.masterList = [];
            logToScreen(`Rendering Dashboard with ${appData.masterList.length} total items.`);

            const tableBody = document.getElementById('table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : 'all'; };

            const fTerritoryVals = getMultiSelectValues('ms-territory');
            const fInspVals = getMultiSelectValues('ms-inspection');

            const fProp = getVal('filter-property');
            const fReady = getVal('filter-ready');
            const fWeb = getVal('filter-web');
            const fNet = getVal('filter-net');
            const hiddenMode = getVal('filter-hidden-mode');
            const searchEl = document.getElementById('search-input');
            const fSearch = searchEl ? searchEl.value.toLowerCase() : '';

            const filtered = appData.masterList.filter(item => {
                // HIDDEN LOGIC: 3 Modes
                const isHidden = appData.hidden.has(item.key);
                if (hiddenMode === 'hide' && isHidden) return false;
                if (hiddenMode === 'only' && !isHidden) return false;
                // if 'all', we allow both (pass through)

                // Multi-Select Logic: if 'all', pass. Else, item must be IN values.
                if (fTerritoryVals !== 'all' && !fTerritoryVals.includes(item.territory)) return false;
                if (fInspVals !== 'all' && !fInspVals.includes(item.inspectionStatus)) return false;

                if (fProp !== 'all' && item.property !== fProp) return false;
                if (fReady === 'Yes' && !item.rentReady) return false;
                if (fReady === 'No' && item.rentReady) return false;

                if (fWeb === 'Yes' && !item.postedWeb) return false;
                if (fWeb === 'No' && item.postedWeb) return false;
                if (fNet === 'Yes' && !item.postedNet) return false;
                if (fNet === 'No' && item.postedNet) return false;
                if (fSearch) {
                    const text = `${item.property} ${item.unit}`.toLowerCase();
                    if (!text.includes(fSearch)) return false;
                }
                return true;
            });

            updateStats(filtered);

            // Pagination Logic
            const pageSizeEl = document.getElementById('page-size');
            const pageSize = parseInt(pageSizeEl ? pageSizeEl.value : 25);
            const totalPages = Math.ceil(filtered.length / pageSize);
            if (activePage > totalPages && totalPages > 0) activePage = 1; // Reset to 1 if current page is out of bounds
            else if (totalPages === 0) activePage = 0; // No pages if no data

            const start = (activePage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = filtered.slice(start, end);

            const infoEl = document.getElementById('page-info');
            if (infoEl) infoEl.innerText = `Showing ${filtered.length > 0 ? start + 1 : 0}-${Math.min(end, filtered.length)} of ${filtered.length}`;

            // Update pagination controls
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            if (prevBtn) prevBtn.disabled = activePage <= 1;
            if (nextBtn) nextBtn.disabled = activePage >= totalPages;

            pageData.forEach(item => {
                const tr = document.createElement('tr');
                let inspBadgeClass = 'badge-none';
                if (item.inspectionStatus === 'NEW') inspBadgeClass = 'badge-new';
                else if (item.inspectionStatus === 'IN PROGRESS') inspBadgeClass = 'badge-progress';
                else if (item.inspectionStatus === 'DONE') inspBadgeClass = 'badge-done';

                let woHtml = '<span class="badge badge-none">None</span>';
                if (item.workOrderStatus !== 'NONE') {
                    woHtml = `<div style="display:flex;flex-direction:column;gap:2px"><span class="badge badge-progress">${item.workOrderStatus}</span>${item.workOrderEst ? `<span style="font-size:10px;color:var(--text-secondary)">$${item.workOrderEst}</span>` : ''}</div>`;
                }

                const alertStyle = (item.rentReady && (!item.postedWeb || !item.postedNet)) ? 'background:rgba(239,68,68,0.1); border-left:2px solid var(--danger);' : '';
                const isHidden = appData.hidden.has(item.key);
                const rowOpacity = isHidden ? 'opacity:0.6;' : '';

                tr.innerHTML = `
                    <td style="${rowOpacity}"><strong>${item.property}</strong>${isHidden ? ' <span class="badge badge-none" style="font-size:9px">HIDDEN</span>' : ''}</td>
                    <td style="${rowOpacity}">${item.unit}</td>
                    <td style="${rowOpacity}">${item.bedBath}</td>
                    <td style="${rowOpacity}">${item.moveOutDate || '-'}</td>
                    <td style="${rowOpacity}">${item.daysVacant}</td>
                    <td style="${rowOpacity}"><span class="badge ${inspBadgeClass}">${item.inspectionStatus}</span></td>
                    <td style="${rowOpacity}">${woHtml}</td>
                    <td style="${rowOpacity}"><span class="badge badge-none">${item.estApprovalStatus}</span></td>
                    <td style="${rowOpacity}"><div style="display:flex;align-items:center;"><span class="status-dot ${item.rentReady ? 'green' : 'red'}"></span>${item.rentReady ? 'Yes' : 'No'}</div></td>
                    <td style="${alertStyle} ${rowOpacity}"><div style="display:flex;gap:4px;"><span class="badge ${item.postedWeb ? 'badge-new' : 'badge-none'}">WEB</span><span class="badge ${item.postedNet ? 'badge-new' : 'badge-none'}">NET</span></div></td>
                    <td>
                        <button style="background:none;border:none;color:var(--text-secondary);cursor:pointer;transition:color 0.2s;" 
                                title="${isHidden ? 'Unhide Unit' : 'Hide Unit'}" 
                                onclick="toggleHidden('${item.key}')"
                                onmouseover="this.style.color=var(--accent)"
                                onmouseout="this.style.color=var(--text-secondary)">
                            <i class="fa-solid ${isHidden ? 'fa-eye' : 'fa-eye-slash'}"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function toggleHidden(key) {
            if (appData.hidden.has(key)) {
                appData.hidden.delete(key);
            } else {
                appData.hidden.add(key);
            }

            // Optimistic Client Update
            renderDashboard();

            // Sync with Server (or LocalStorage)
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                localStorage.setItem('mrb_hidden', JSON.stringify([...appData.hidden]));
                console.log("Local Hidden Updated", appData.hidden);
            } else {
                google.script.run.withFailureHandler(e => alert("Failed to sync hidden status: " + e))
                    .setHiddenUnits([...appData.hidden]); // Requires backend function
            }
        }

        function unhideAll() {
            if (appData.hidden.size === 0) return;
            if (!confirm(`Are you sure you want to unhide all ${appData.hidden.size} hidden units?`)) return;

            appData.hidden.clear();

            // Optimistic Update
            document.getElementById('filter-hidden-mode').value = 'hide';
            renderDashboard();

            // Sync
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                localStorage.setItem('mrb_hidden', JSON.stringify([]));
                console.log("Local Hidden Cleared");
            } else {
                google.script.run.withFailureHandler(e => alert("Failed to clear hidden: " + e))
                    .setHiddenUnits([]);
            }
        }

        function updateStats(data) {
            const setTxt = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };
            setTxt('val-vacant', data.length);
            setTxt('val-not-ready', data.filter(i => !i.rentReady).length);
            setTxt('val-no-insp', data.filter(i => i.inspectionStatus === 'NONE').length);
            const days = data.map(i => i.daysVacant).filter(d => d > 0);
            const avg = days.length ? Math.round(days.reduce((a, b) => a + b, 0) / days.length) : 0;
            setTxt('val-avg-days', avg);
        }
        // RRWW Easter Egg Logic
        (function () {
            let keySeq = []; let eggTimer = null;
            document.addEventListener('keyup', (e) => {
                // Allow Control, Meta (Command on Mac), or Shift
                if (['Control', 'Meta', 'Shift'].includes(e.key)) {
                    keySeq.push(e.key);
                    // console.log('Egg Key:', e.key, keySeq.length);
                    if (eggTimer) clearTimeout(eggTimer);
                    eggTimer = setTimeout(() => { keySeq = []; }, 1000);
                    if (keySeq.length === 4) { showEasterEgg(); keySeq = []; }
                } else {
                    keySeq = [];
                }
            });
            function showEasterEgg() {
                const logo = document.getElementById('hidden-logo'); if (!logo) return;
                logo.style.display = 'block'; logo.style.opacity = '1';
                setTimeout(() => {
                    const rect = logo.getBoundingClientRect(); const cx = rect.left + rect.width / 2; const cy = rect.top + rect.height / 2;
                    for (let i = 0; i < 80; i++) {
                        const p = document.createElement('div'); p.classList.add('particle');
                        const angle = Math.random() * Math.PI * 2; const dist = 150 + Math.random() * 250;
                        const tx = Math.cos(angle) * dist; const ty = Math.sin(angle) * dist;
                        p.style.setProperty('--tx', tx + 'px'); p.style.setProperty('--ty', ty + 'px');
                        p.style.left = cx + 'px'; p.style.top = cy + 'px';
                        p.style.width = (4 + Math.random() * 8) + 'px'; p.style.height = p.style.width;
                        const colors = ['#3b82f6', '#8b5cf6', '#fff', '#0ea5e9'];
                        p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        document.body.appendChild(p); setTimeout(() => p.remove(), 1200);
                    }
                    logo.style.display = 'none';
                }, 2000);
            }
        })();
    </script>
</body>

</html>